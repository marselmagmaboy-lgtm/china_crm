{% extends "admin/base_site.html" %}

{% block content %}
<style>
    /* ... (—Å—Ç–∏–ª–∏ —Ç–µ –∂–µ, –ø–ª—é—Å –Ω–æ–≤—ã–µ) ... */
    body, html { height: 100%; overflow: hidden; }
    .content { padding: 0 !important; margin: 0 !important; }
    .tg-container { display: flex; height: 88vh; background: #17212b; color: white; border-top: 1px solid #333; font-family: sans-serif; }
    
    /* SIDEBAR */
    .tg-sidebar { width: 350px; background: #17212b; border-right: 1px solid #0e1621; display: flex; flex-direction: column; overflow-y: auto; }
    .tg-item { padding: 10px 15px; cursor: pointer; display: flex; gap: 12px; border-bottom: 1px solid transparent; transition: 0.2s; }
    .tg-item:hover { background: #202b36; }
    .tg-item.active { background: #2b5278; }
    .avatar { min-width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: white; }
    .tg-info { flex: 1; overflow: hidden; }
    .tg-name { font-weight: 600; font-size: 15px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tg-preview { font-size: 14px; color: #8faec5; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; }
    .unread-dot { width: 10px; height: 10px; background: #3e7eb8; border-radius: 50%; display: inline-block; margin-right: 5px; }

    /* MAIN CHAT */
    .tg-main { flex: 1; display: flex; flex-direction: column; background: #0e1621; }
    .tg-header { padding: 10px 20px; background: #17212b; border-bottom: 1px solid #0e1621; display: flex; justify-content: space-between; align-items: center; height: 50px; }
    .tg-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; background: #0e1621; }
    
    .msg { max-width: 65%; padding: 8px 12px; border-radius: 12px; position: relative; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
    .msg.client { align-self: flex-start; background: #182533; border-bottom-left-radius: 0; }
    .msg.manager { align-self: flex-end; background: #2b5278; border-bottom-right-radius: 0; }
    .msg-img { max-width: 100%; border-radius: 10px; margin-bottom: 5px; cursor: pointer; }
    .msg-audio { width: 250px; margin-top: 5px; }
    .msg-time { font-size: 11px; color: #6c7883; float: right; margin-left: 10px; margin-top: 5px; }

    /* INPUT AREA */
    .tg-input-area { padding: 10px; background: #17212b; display: flex; gap: 10px; align-items: center; }
    .file-btn { font-size: 24px; cursor: pointer; color: #6c7883; padding: 5px; }
    .file-btn:hover { color: #667eea; }
    .tg-input-area input[type="text"] { flex: 1; background: #0e1621; border: none; color: white; padding: 12px; border-radius: 10px; outline: none; }
    .send-btn { background: none; border: none; color: #667eea; font-size: 28px; cursor: pointer; }
</style>

<div class="tg-container">
    <div class="tg-sidebar" id="sidebar">
        </div>

    <div class="tg-main">
        {% if active_lead %}
            <div class="tg-header">
                <div>
                    <strong>{{ active_lead.first_name }}</strong> <small style="color: #888;">@{{ active_lead.telegram_username }}</small>
                </div>
                <a href="/admin/core/lead/{{ active_lead.id }}/change/" style="color: #667eea; text-decoration: none; font-size: 13px;">üìù –ü—Ä–æ—Ñ–∏–ª—å</a>
            </div>

            <div class="tg-messages" id="chatArea"></div>

            <form method="POST" enctype="multipart/form-data" class="tg-input-area">
                {% csrf_token %}
                
                <label for="fileInput" class="file-btn">üìé</label>
                <input type="file" name="attachment" id="fileInput" style="display: none;" onchange="alert('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ' + this.files[0].name)">
                
                <input type="text" name="message_text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" autofocus>
                <button type="submit" class="send-btn">‚û§</button>
            </form>
        {% else %}
            <div style="display: flex; height: 100%; align-items: center; justify-content: center; color: #667eea;">‚Üê –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
        {% endif %}
    </div>
</div>

<script>
    const chatArea = document.getElementById('chatArea');
    const sidebar = document.getElementById('sidebar');
    let isFirstLoad = true;

    function renderMessages(messages) {
        if (!chatArea) return;
        
        // –•–∞–∫: –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞–ª–æ –±–æ–ª—å—à–µ, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        const currentCount = chatArea.querySelectorAll('.msg').length;
        if (messages.length <= currentCount && !isFirstLoad) return;

        let html = '';
        messages.forEach(msg => {
            let content = '';
            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (msg.type === 'image' && msg.file_url) {
                content += `<img src="${msg.file_url}" class="msg-img" onclick="window.open(this.src)">`;
                if (msg.text) content += `<div>${msg.text}</div>`;
            } else if (msg.type === 'voice' && msg.file_url) {
                content += `<audio controls src="${msg.file_url}" class="msg-audio"></audio>`;
            } else {
                content += msg.text || '';
            }

            html += `
                <div class="msg ${msg.is_manager ? 'manager' : 'client'}">
                    ${content}
                    <span class="msg-time">${msg.time}</span>
                </div>
            `;
        });
        chatArea.innerHTML = html;
        chatArea.scrollTop = chatArea.scrollHeight;
        isFirstLoad = false;
    }

    function renderSidebar(leads) {
        let html = '';
        leads.forEach(lead => {
            const activeClass = lead.active ? 'active' : '';
            const unread = lead.status === 'new' ? '<span class="unread-dot"></span>' : '';
            
            html += `
            <div class="tg-item ${activeClass}" onclick="window.location.href='/admin/chat/${lead.id}/'">
                <div class="avatar">${lead.name.charAt(0)}</div>
                <div class="tg-info">
                    <div style="display:flex; justify-content:space-between;">
                        <span class="tg-name">${unread} ${lead.name}</span>
                        <span style="font-size: 11px; color: #666;">${lead.time}</span>
                    </div>
                    <p class="tg-preview">${lead.preview}</p>
                </div>
            </div>`;
        });
        sidebar.innerHTML = html;
    }

    function refreshData() {
        fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.json())
        .then(data => {
            if (data.leads) renderSidebar(data.leads);
            if (data.messages) renderMessages(data.messages);
        })
        .catch(console.error);
    }

    setInterval(refreshData, 2000);
    refreshData(); // –ó–∞–ø—É—Å–∫ —Å—Ä–∞–∑—É
</script>
{% endblock %}