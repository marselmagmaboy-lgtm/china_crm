{% extends "admin/base.html" %}

{% block extrahead %}
<style>
    /* –ö—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ */
    .live-badge {
        background-color: #ff4b4b; color: white; border-radius: 10px; padding: 2px 7px;
        font-size: 11px; font-weight: bold; margin-left: 10px; vertical-align: middle;
        box-shadow: 0 0 8px rgba(255, 75, 75, 0.8); animation: pulse 1.5s infinite; display: inline-block;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (Toast) */
    .toast-box {
        position: fixed; top: 20px; right: -300px; background: #1e1e1e; color: white; border-left: 5px solid #ff4b4b;
        padding: 15px 20px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        z-index: 99999; transition: right 0.5s ease; display: flex; align-items: center; gap: 15px; font-family: sans-serif;
    }
    .toast-box.show { right: 20px; }

    /* –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ (–µ—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ) */
    #soundBtn {
        position: fixed; bottom: 20px; right: 20px; background: #ff4b4b; color: white;
        padding: 10px 15px; border-radius: 30px; cursor: pointer; display: none; z-index: 99999;
        font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-family: sans-serif;
    }
</style>

<audio id="globalSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<div id="liveToast" class="toast-box">
    <div style="font-size: 24px;">üí¨</div>
    <div>
        <div style="font-weight: bold;">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</div>
        <div style="font-size: 12px; color: #ccc;">–ö–ª–∏–µ–Ω—Ç –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞</div>
    </div>
</div>

<div id="soundBtn">üîá –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const sound = document.getElementById("globalSound");
        const toast = document.getElementById("liveToast");
        const soundBtn = document.getElementById("soundBtn");
        let lastCount = -1;

        // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞—Ç—å –∑–≤—É–∫ (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–∫–∏)
        function tryPlaySound() {
            sound.currentTime = 0;
            const playPromise = sound.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("–ó–≤—É–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É.");
                    soundBtn.style.display = "block"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–ø–∞—Å–µ–Ω–∏—è
                });
            }
        }

        // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–≤—É–∫ –Ω–∞–≤—Å–µ–≥–¥–∞
        soundBtn.addEventListener("click", function() {
            sound.play();
            soundBtn.style.display = "none";
            alert("–ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ —Å–ª—ã—à–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.");
        });

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        function checkUnread() {
            fetch('/api/unread-count/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.json())
            .then(data => {
                const count = data.count;
                console.log("–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:", count); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12)

                // 1. –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–∂–æ—á–∫–∏ –≤ –º–µ–Ω—é
                const chatLinks = document.querySelectorAll('a[href*="/admin/chat/"]');
                chatLinks.forEach(link => {
                    let badge = link.querySelector('.live-badge');
                    if (count > 0) {
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'live-badge';
                            link.appendChild(badge);
                        }
                        badge.innerText = count;
                        document.title = `(${count}) Admin NSRE`;
                    } else {
                        if (badge) badge.remove();
                        document.title = "Admin NSRE";
                    }
                });

                // 2. –ï—Å–ª–∏ —Å—Ç–∞–ª–æ –ë–û–õ–¨–®–ï - —É–≤–µ–¥–æ–º–ª—è–µ–º
                if (lastCount !== -1 && count > lastCount) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É
                    toast.classList.add("show");
                    setTimeout(() => toast.classList.remove("show"), 5000);
                    
                    // –ò–≥—Ä–∞–µ–º –∑–≤—É–∫
                    tryPlaySound();
                }
                lastCount = count;
            })
            .catch(err => console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:", err));
        }

        setInterval(checkUnread, 2000); // –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    });
</script>
{% endblock %}