{% extends "admin/base_site.html" %}

{% block content %}
<div style="display: flex; gap: 20px; height: 80vh;">
    
    <div style="flex: 2; display: flex; flex-direction: column; background: #1e1e1e; border-radius: 10px; padding: 20px;">
        <h2 style="color: white;">–ß–∞—Ç —Å {{ lead.first_name }}</h2>
        
        <div style="flex: 1; overflow-y: auto; margin-bottom: 20px; padding-right: 10px; display: flex; flex-direction: column; gap: 10px;" id="chat-window">
            {% for msg in messages %}
                <div style="max-width: 70%; padding: 10px; border-radius: 10px; 
                            {% if msg.is_from_manager %}
                                align-self: flex-end; background-color: #0056b3; color: white;
                            {% else %}
                                align-self: flex-start; background-color: #333; color: #ddd;
                            {% endif %}">
                    <strong>{% if msg.is_from_manager %}–í—ã{% else %}{{ lead.first_name }}{% endif %}:</strong><br>
                    {{ msg.text }}
                    <div style="font-size: 0.7em; opacity: 0.7; text-align: right;">{{ msg.created_at|date:"H:i" }}</div>
                </div>
            {% empty %}
                <p style="text-align: center; color: gray;">–ò—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>
            {% endfor %}
        </div>

        <form method="POST" style="display: flex; gap: 10px;">
            {% csrf_token %}
            <input type="text" name="message_text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required style="flex: 1; padding: 10px; border-radius: 5px; border: none;">
            <button type="submit" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ‚úàÔ∏è</button>
        </form>
    </div>

    <div style="flex: 1; background: #2c2c2c; padding: 20px; border-radius: 10px; color: white;">
        <h3>üìù –î–∞–Ω–Ω—ã–µ –õ–∏–¥–∞</h3>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="update_lead" value="true">
            
            <label>–ò–º—è / –ù–∏–∫–Ω–µ–π–º:</label>
            <input type="text" name="first_name" value="{{ lead.first_name }}" style="width: 100%; margin-bottom: 10px; padding: 5px;">
            
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –¶–µ–ª—å:</label>
            <textarea name="manager_comment" rows="10" style="width: 100%; padding: 5px;">{{ lead.manager_comment }}</textarea>
            
            <br><br>
            <button type="submit" class="btn btn-primary" style="width: 100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </form>

        <hr style="border-color: #555;">
        <p>Telegram: @{{ lead.telegram_username }}</p>
        <p>–°—Ç–∞—Ç—É—Å: {{ lead.get_status_display }}</p>
        <a href="/admin/core/lead/{{ lead.id }}/change/" style="color: #4facfe;">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É -></a>
    </div>

</div>

<script>
    var chatWindow = document.getElementById("chat-window");
    chatWindow.scrollTop = chatWindow.scrollHeight;
</script>
{% endblock %}